<!doctype html><html lang="ru" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="description" content="Официальная документация для разработчиков и администаротов ICOD.Cloud"><link rel="canonical" href="http://doc.icod.cloud/developer/backend/apiendpoint/"><meta name="author" content="ICOD.Cloud"><meta name="lang:clipboard.copy" content="Копировать в буфер"><meta name="lang:clipboard.copied" content="Скопировано в буфер"><meta name="lang:search.language" content="ru, en"><meta name="lang:search.pipeline.stopwords" content="True"><meta name="lang:search.pipeline.trimmer" content="True"><meta name="lang:search.result.none" content="Совпадений не найдено"><meta name="lang:search.result.one" content="Найдено 1 совпадение"><meta name="lang:search.result.other" content="Найдено # совпадений"><meta name="lang:search.tokenizer" content="[\s\-]+"><link rel="shortcut icon" href="../../.."><meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.3.1"><title>Метод API - ICOD.Cloud Developer Documentation</title><link rel="stylesheet" href="../../../assets/stylesheets/application.4031d38b.css"><link rel="stylesheet" href="../../../assets/stylesheets/application-palette.224b79ff.css"><meta name="theme-color" content="#3f51b5"><script src="../../../assets/javascripts/modernizr.74668098.js"></script><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=swap"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel="stylesheet" href="../../../assets/fonts/material-icons.css"></head><body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="deeppurple"><svg class="md-svg"><defs><svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg></defs></svg> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" data-md-component="overlay" for="__drawer"></label><a href="#api" tabindex="1" class="md-skip">Перейти к содержанию </a><header class="md-header" data-md-component="header"><nav class="md-header-nav md-grid"><div class="md-flex"><div class="md-flex__cell md-flex__cell--shrink"><a href="http://doc.icod.cloud" title="ICOD.Cloud Developer Documentation" class="md-header-nav__button md-logo"><i class="md-icon"></i></a></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label></div><div class="md-flex__cell md-flex__cell--stretch"><div class="md-flex__ellipsis md-header-nav__title" data-md-component="title"><span class="md-header-nav__topic">ICOD.Cloud Developer Documentation</span><span class="md-header-nav__topic">Метод API</span></div></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--search md-header-nav__button" for="__search"></label><div class="md-search" data-md-component="search" role="dialog"><label class="md-search__overlay" for="__search"></label><div class="md-search__inner" role="search"><form class="md-search__form" name="search"><input type="text" class="md-search__input" name="query" placeholder="Поиск" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active"> <label class="md-icon md-search__icon" for="__search"></label> <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button></form><div class="md-search__output"><div class="md-search__scrollwrap" data-md-scrollfix><div class="md-search-result" data-md-component="result"><div class="md-search-result__meta">Начните печатать для поиска</div><ol class="md-search-result__list"></ol></div></div></div></div></div></div><div class="md-flex__cell md-flex__cell--shrink"><div class="md-header-nav__source"><a href="https://github.com/ICOD-Cloud/icod-dev-docs/" title="Перейти к репозиторию" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">GitHub</div></a></div></div></div></nav></header><div class="md-container"><nav class="md-tabs md-tabs--active" data-md-component="tabs"><div class="md-tabs__inner md-grid"><ul class="md-tabs__list"><li class="md-tabs__item"><a href="../../../admin/" title="Администратор" class="md-tabs__link">Администратор</a></li><li class="md-tabs__item"><a href="../../" title="Разработчик" class="md-tabs__link md-tabs__link--active">Разработчик</a></li></ul></div></nav><main class="md-main"><div class="md-main__inner md-grid" data-md-component="container"><div class="md-sidebar md-sidebar--primary" data-md-component="navigation"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--primary" data-md-level="0"><label class="md-nav__title md-nav__title--site" for="__drawer"><a href="http://doc.icod.cloud" title="ICOD.Cloud Developer Documentation" class="md-nav__button md-logo"><i class="md-icon"></i></a>ICOD.Cloud Developer Documentation</label><div class="md-nav__source"><a href="https://github.com/ICOD-Cloud/icod-dev-docs/" title="Перейти к репозиторию" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">GitHub</div></a></div><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1"><label class="md-nav__link" for="nav-1">Администратор</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-1">Администратор</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../../admin/" title="О Документации" class="md-nav__link">О Документации</a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked><label class="md-nav__link" for="nav-2">Разработчик</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-2">Разработчик</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../" title="Приветствие" class="md-nav__link">Приветствие</a></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2" checked><label class="md-nav__link" for="nav-2-2">Backend</label><nav class="md-nav" data-md-component="collapsible" data-md-level="2"><label class="md-nav__title" for="nav-2-2">Backend</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../" title="Описание" class="md-nav__link">Описание</a></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-2" type="checkbox" id="nav-2-2-2" checked><label class="md-nav__link" for="nav-2-2-2">Быстрый Старт</label><nav class="md-nav" data-md-component="collapsible" data-md-level="3"><label class="md-nav__title" for="nav-2-2-2">Быстрый Старт</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../install/" title="Установка" class="md-nav__link">Установка</a></li><li class="md-nav__item"><a href="../module/" title="Модуль" class="md-nav__link">Модуль</a></li><li class="md-nav__item md-nav__item--active"><input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc"><label class="md-nav__link md-nav__link--active" for="__toc">Метод API</label><a href="./" title="Метод API" class="md-nav__link md-nav__link--active">Метод API</a><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Содержание</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#_1" title="Создаем новый метод" class="md-nav__link">Создаем новый метод</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#viewphp" title="View.php" class="md-nav__link">View.php</a></li><li class="md-nav__item"><a href="#viewapijson" title="View.api.json" class="md-nav__link">View.api.json</a></li></ul></nav></li><li class="md-nav__item"><a href="#_2" title="Встроенные фильтры" class="md-nav__link">Встроенные фильтры</a></li><li class="md-nav__item"><a href="#_3" title="Встроенные валидаторы" class="md-nav__link">Встроенные валидаторы</a></li><li class="md-nav__item"><a href="#_4" title="Расширение валидации и фильтрации" class="md-nav__link">Расширение валидации и фильтрации</a></li></ul></nav></li></ul></nav></li><li class="md-nav__item"><a href="../acl/" title="ACL" class="md-nav__link">ACL</a></li><li class="md-nav__item"><a href="../events/" title="События" class="md-nav__link">События</a></li><li class="md-nav__item"><a href="../cli/" title="CLI" class="md-nav__link">CLI</a></li><li class="md-nav__item"><a href="../json/" title="JSON" class="md-nav__link">JSON</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3"><label class="md-nav__link" for="nav-2-3">Frontend</label><nav class="md-nav" data-md-component="collapsible" data-md-level="2"><label class="md-nav__title" for="nav-2-3">Frontend</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../frontend/" title="О Документации" class="md-nav__link">О Документации</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4"><label class="md-nav__link" for="nav-2-4">PRT</label><nav class="md-nav" data-md-component="collapsible" data-md-level="2"><label class="md-nav__title" for="nav-2-4">PRT</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../../index3/" title="О Документации" class="md-nav__link">О Документации</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5"><label class="md-nav__link" for="nav-2-5">Docs</label><nav class="md-nav" data-md-component="collapsible" data-md-level="2"><label class="md-nav__title" for="nav-2-5">Docs</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../../index4/" title="О Документации" class="md-nav__link">О Документации</a></li></ul></nav></li></ul></nav></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component="toc"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">Содержание</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#_1" title="Создаем новый метод" class="md-nav__link">Создаем новый метод</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#viewphp" title="View.php" class="md-nav__link">View.php</a></li><li class="md-nav__item"><a href="#viewapijson" title="View.api.json" class="md-nav__link">View.api.json</a></li></ul></nav></li><li class="md-nav__item"><a href="#_2" title="Встроенные фильтры" class="md-nav__link">Встроенные фильтры</a></li><li class="md-nav__item"><a href="#_3" title="Встроенные валидаторы" class="md-nav__link">Встроенные валидаторы</a></li><li class="md-nav__item"><a href="#_4" title="Расширение валидации и фильтрации" class="md-nav__link">Расширение валидации и фильтрации</a></li></ul></nav></div></div></div><div class="md-content"><article class="md-content__inner md-typeset"><a href="https://github.com/ICOD-Cloud/icod-dev-docs/edit/master/docs/developer/backend/apiendpoint.md" title="Редактировать страницу" class="md-icon md-content__icon">&#xE3C9;</a><h1 id="api">Методы API</h1>
<p>Теперь нам нужно создать метод API. Другими словами URL на который будет сделаться <code>POST</code> запрос.</p>
<p>Хочу сразу сказать что API ICOD сделан не по технологии REST API. ICOD утилизирует идеологию JSON API. Она гибче и универсальней. Если интересно доп чтиво, <a href="http://habrahabr.ru/post/265845/">смотрите тут</a>.</p>
<p>Для создания запросов нужно понимать следующее:</p>
<ul>
<li>ICOD API принимает только запросы <code>POST</code></li>
<li>Все параметры для исполняемого метода должны передаваться в теле запроса <code>POST</code> как JSON.</li>
<li>Обязательно отравить заголовок <code>Content Type: application/json</code>.</li>
<li>ICOD API всегда вернет HTTP код 200 даже если будет ошибка. Просто при ошибке ключ <code>error</code> будет <code>true</code> и остальное содержать данные ошибки.</li>
<li>Есть несколько параметров которые веб приложение передает с каждым запросом.</li>
<li><code>lang</code> - Выбранный пользователем язык интерфейса.</li>
<li><code>client</code> - Клиент веб приложения это может быть веб браузер, мобильное приложение или настольное приложение. Этот параметр используется для определения авторизации конкретного устройства.</li>
<li><code>auth_uid</code> - ID пользователя авторизованно в данный момент времени. Если вы делает запросы которые требуют авторизации или работу с ACL этот параметр будет использован для проверки прав доступа.</li>
<li><code>auth_token</code> - Подпись авторизации пользователя. Что бы ее получить, выполните метод API <code>users/profile/login</code> в первую очередь. Потом воспользуйтесь подписью которая будет создана в таблице <code>user_token</code>.</li>
</ul>
<h2 id="_1">Создаем новый метод</h2>
<p>Что бы создать метод запусти команду</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>icod method users manage view
</pre></div>
</td></tr></table>

<p>Где</p>
<ul>
<li><code>users</code> - имя модуля.</li>
<li><code>manage</code> - имя группы методов API.</li>
<li><code>view</code> - имя самого метода.</li>
</ul>
<p>Если вы видите сообщение об успешном выполнении, вы можете перейти в папку <code>modules/users/Api/Manage/</code> и там вы найдете созданные файлы. Урл для этого метода будет <code>users/manage/view</code>.</p>
<p>Будет создано 2 файла.</p>
<h3 id="viewphp">View.php</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Users\Api\Manage</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;_API&#39;</span><span class="p">))</span> <span class="k">exit</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">View</span> <span class="k">extends</span> <span class="nx">\App\Lib\Api</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(){</span>
        <span class="c1">// make DB calls and return array or object</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Вот что нужно понимать об этом файле</p>
<ol>
<li>Namespace должно быть <code>[Имя модуля]\Api\[Имя группы методов]</code>.</li>
<li>Имя класса должно соответствовать имени файла.</li>
<li>Класс должен наследовать от <code>\App\Lib\Api</code>.</li>
<li>В классе должен быть как минимум метод <code>execute()</code>.</li>
</ol>
<p>Ну и теперь вы можете внутри метода <code>execute()</code> делать все что вы хотите. Вы можете вернуть строку, объект, массив или <code>1</code> что бы просто сообщить об успешном завершении.</p>
<h3 id="viewapijson">View.api.json</h3>
<p>Этот файл заслуживает особого внимания. Понимание этого файла может сохранить вам много времени работы. Не забудьте посмотреть основы работы с <a href="../json/">JSON тут</a>.</p>
<p>Этот файл имеет 2 основных назначения.</p>
<ol>
<li>
<p><strong>Документация</strong> - На основе этих файлов генерируется автоматическая документация, так что вы как разработчик всегда знаете все методы которые только есть в ICOD. Вы знаете как из запустить, что им передать и так далее.</p>
</li>
<li>
<p><strong>Валидация</strong> - Автоматическая проверка и фильтрация передаваемых параметров. В конечном итоге вам не нужно проверять переданные параметры и в методе <code>execute()</code> вы можете просто исполнять логику, вместо того что бы писать кучу кода по проверке входных данных.</p>
</li>
</ol>
<blockquote>
<p>Метод API будет работать и без этого фала. Он не обязательный сам по себе. Но естественно вам нужно будет самостоятельно все проверить.</p>
</blockquote>
<p>Вот пример файла.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Получаем список всех записей гостевой книги.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ans&quot;</span><span class="p">:</span> <span class="s2">&quot;guestbook.manage.view&quot;</span><span class="p">,</span>
    <span class="nt">&quot;require_id&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">[{},</span> <span class="p">{}],</span>
    <span class="nt">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[{},</span> <span class="p">{}]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Описание параметров</p>
<ul>
<li><code>description</code> - Обязательный. Описание метода.</li>
<li><code>ans</code> - ANS это Access Namespace. Это имя правила для автоматической проверки доступа к данному методу. Читайте о ACL <a href="../acl/">подробнее тут</a>.</li>
<li><code>require_id</code> - Проверяет передан ли ID или нет. В любом URI метода можно опционально передать ID. Например <code>/users/manage/view/12</code>. Этот параметр хорош в методах удаления, редактирования или просмотра отдельного документа.</li>
</ul>
<p>Этот параметр не только проверит обязательность данного параметра, но и осуществить проверку доступа ACL на основе прав для отдельной записи в базе если они существуют.</p>
<p>Если этот параметр <code>true</code> то доступ к ID внутри метода <code>execute()</code> вы получите через <code>$this-&gt;id</code>. Вам не надо проверять есть он или нет. Если его не было до метод <code>execute()</code> даже не запуститься. Это касается автоматической проверки всех входных параметров.</p>
<ul>
<li><code>errors</code> - Массив объектов JSON описывающий возможные ошибки которые этот метод может вернуть. Всего 2 параметра. Код ошибки и ее описание.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Не могу удалить запись гостевой книги, пока в ней есть комментарии.&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>params</code> - Массив объектов JSON описывающий параметры которые можно передать методу.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;q&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
    <span class="nt">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;example&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Search query to apply to Items list.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;validate&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;regex&quot;</span><span class="p">,</span>
            <span class="nt">&quot;rule&quot;</span><span class="p">:</span> <span class="s2">&quot;/^[a-zA-Z\\-]*$/iU&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;filter&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span>
            <span class="nt">&quot;rule&quot;</span><span class="p">:</span> <span class="s2">&quot;trim,strtolower&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Для доступа к параметрам в <code>execute()</code> используйте метод <code>get</code> где первый параметр это имя параметра и второй значение по умолчанию.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="x">$this-&gt;get(&#39;limit&#39;, 10);</span>
</pre></div>
</td></tr></table>

<p>Значение по умолчанию будет назначено только если самого параметра не было передано. Если параметр был передан и он пуст, то метод гет это и вернет. Если параметр был помечен как <code>required</code> то можно не вводить значение по умолчанию, так как он обязательно там будет.</p>
<ul>
<li><code>name</code> - Имя параметра. Это ключ который будет добавлен в тело JSON отправляемого на точку доступа.</li>
<li><code>type</code> - Тип параметра. Может быть string, boolen, integer, ... Нет ни какой магии за этим параметром, это только для документации.</li>
<li><code>default</code> - Значение по умолчанию. Здесь есть магия. Если выполните <code>$this-&gt;get('q')</code> а параметр <code>q</code> был пуст, то вы получите значение которое прописали тут.</li>
<li><code>example</code> - Чисто для документации пример как может выглядеть значение параметра.</li>
<li><code>required</code> - Проверит обязательность данного параметра. Проверит после фильтрации. Другими словами если параметр обязательный вы можете смело использовать <code>$this-&gt;get('q')</code> и быть уверенным что там есть значение.</li>
<li><code>description</code> - Опять же для документации.</li>
<li><code>validate</code> - Массив валидаторов которые нужно применить к параметру. Валидаторы применяются после фильтрации.</li>
<li><code>filter</code> - Массив фильтров которые должны применится к парамеру перед тем как любые проверки к нему применятся.</li>
</ul>
<h2 id="_2">Встроенные фильтры</h2>
<p>Все фильтры содержатся в файле <code>modules\App\Lib\Api\Filters.php</code>.</p>
<ul>
<li><code>preg_replace</code> - Заменяет по регулярному выражению. Например почистить переменную что бы в ней были только цифры.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;preg_replace&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rule&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;/^[^0-9]*$/iU&quot;</span><span class="p">,</span>
        <span class="nt">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>replace</code> - Простая строковая замена</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rule&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;sun&quot;</span><span class="p">,</span>
        <span class="nt">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;moon&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>single</code> - это стандартные методы PHP которые принимают один параметре и возвращают обработанный такие как <code>trim()</code>, <code>ucfirst()</code> и т.д. Можно назначить несколько таких методов в одном фильтре просто разделив их запятой. Они исполнятся ровно в том порядке в котором записаны.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rule&quot;</span><span class="p">:</span> <span class="s2">&quot;trim,strtolower&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>ids</code> - проверяет что параметр передает массив из целых чисел.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ids&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>bool</code> - превращает парамер в переменную типа булева.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>int</code> - Удаляет из параметра все символы кроме цифр и <code>.</code> при этом заменяет <code>,</code> на <code>.</code>. Если в параметр попадет <code>25,12</code> то фильтр вернет <code>25.12</code>. Но сам тип переменной преобразован не будет и останется строкой.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>digits</code> - Удаляет из параметра все символы кроме цифр.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;digits&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="_3">Встроенные валидаторы</h2>
<p>Кроме валидаторов описанных ниже, есть валидатор <code>required</code>.</p>
<p>Валидаторы хранятся в файле <code>modules\App\Lib\Api\Validators.php</code>.</p>
<ul>
<li><code>regex</code> - Проверяет параметр по регулярному выражению.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;regex&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rule&quot;</span><span class="p">:</span> <span class="s2">&quot;/^[a-zA-Z\\-]*$/iU&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>number</code> - Проверяет что параметр это число и содержит только цифры</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ul>
<li><code>user</code> - Проверяет валидность пользователя. Допустим один из параметров это ID пользователя. Этот валидатор проверит что такой пользователь действительно существует.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="_4">Расширение валидации и фильтрации</h2>
<p>Допустим вам нужно создать свой собственный фильтр или валидатор. Это возможно. Для начала определитесь, этот фильтр или валидатор, может быть полезен другим? Если да то можно расширить файлы библиотеки чтобы новые валидаторы и фильтры стали доступны всем.</p>
<p>Если вам нужно создать валидатор или фильтр для отдельной точки доступа, тогда вы можете создать метод прямо в классе точки доступа.</p>
<p>Чтобы вы не вписали в <code>name</code> потом создайте в своем классе API метод <code>prefix_[name]</code> где префикс это или <code>validate_</code> или <code>filter_</code>.</p>
<p>Например вы хотите создать фильтр который проверит наличие категории при добавлении записи в гостевую книгу. Вот что вы можете определить в JSON точки доступа в списке <code>validate</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;cat_exists&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rule&quot;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Теперь в классе объявите метод.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Guestbook\Api\Manage</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;_API&#39;</span><span class="p">))</span> <span class="k">exit</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">View</span> <span class="k">extends</span> <span class="nx">\App\Lib\Api</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(){</span>
        <span class="c1">// make DB calls and return array or object</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">validate_cat_exists</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$rule</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">\Guestbook\Models\Categories</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Первый параметр <code>$value</code> это само значение передаваемого методу API параметра, а второе это то что содержится в <code>rule</code> в JSON. Так что для одного валидатора вы можете для разных параметров, создавать разные правила валидации.</p>
<p>Тоже самое применимо и к фильтрации, только вернуть нужно отфильтрованное значение.</p>
<p>Ели вы хотите иметь возможность использовать свои фильтры и валидаторы снова и снова в разных точках доступа, создайте файл <code>****/Lib/Filters.php</code> или <code>****/Lib/Validatprs.php</code> если они еще не созданы, где <code>****</code> это имя модуля. В нем создайте класс и добавьте все методы типа <code>validate_cat_exists</code> столько валидаторов и фильтров сколько захотите.</p>
<p>Чтобы эти фильтры и валидаторы стали доступны, нужно расширить класс точки доступа API этим новым классом. Это можно сделать 2мя способами.</p>
<ol>
<li>В классе точки доступа апи добавьте метод <code>__construct</code>.</li>
</ol>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="x">function __construct()</span>
<span class="x">{</span>
<span class="x">    $this-&gt;extends[] = new \Users\Lib\Filters();</span>
<span class="x">}</span>
</pre></div>
</td></tr></table>

<ol>
<li>В JSON файле метода API добавьте свойство <code>extend</code>. Это просто массив из строк, с полным путем к классу где содержаться методы валидации или фильтрации.</li>
</ol>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Получаем список всех записей гостевой книги.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ans&quot;</span><span class="p">:</span> <span class="s2">&quot;Users.manage.view&quot;</span><span class="p">,</span>
    <span class="nt">&quot;extend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;\\Users\\Lib\\Filters&quot;</span><span class="p">],</span>
    <span class="nt">&quot;require_id&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">[{},</span> <span class="p">{}],</span>
    <span class="nt">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[{},</span> <span class="p">{}]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></article></div></div></main><footer class="md-footer"><div class="md-footer-nav"><nav class="md-footer-nav__inner md-grid"><a href="../module/" title="Модуль" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev"><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-back md-footer-nav__button"></i></div><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">Назад</span>Модуль</span></div></a><a href="../acl/" title="ACL" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next"><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">Вперед</span>ACL</span></div><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i></div></a></nav></div><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class="md-footer-copyright"><div class="md-footer-copyright__highlight">2020 ICOD.Cloud</div>powered by <a href="https://www.mkdocs.org">MkDocs</a> and <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a></div></div></div></footer></div><script src="../../../assets/javascripts/application.b260a35d.js"></script><script src="../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script><script src="../../../assets/javascripts/lunr/lunr.ru.js"></script><script src="../../../assets/javascripts/lunr/lunr.multi.js"></script><script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script></body></html>